import{a as Be}from"./chunk-VVFK3ZJM.js";import{a as U}from"./chunk-4XJVTLNE.js";import{a as Ge}from"./chunk-E43OPYTD.js";import{a as Oe}from"./chunk-MACJAMH4.js";import{a as je,b as Fe}from"./chunk-G7FI4UIO.js";import{e as Se,f as Ie,h as Re,j as Ae,k as we}from"./chunk-LHJDZAOM.js";import"./chunk-Z2UCWZAT.js";import{a as $e,b as He}from"./chunk-LBLC3GWP.js";import{a as Pe,b as Ve}from"./chunk-IVLG6K77.js";import{c as z}from"./chunk-T4ZPX6JM.js";import{$ as Z,$a as be,C as de,Ca as _,Cb as Le,Ea as d,Fa as _e,Ga as Ce,Ha as j,Ia as O,J as he,Ja as M,Ka as D,La as E,M as fe,Ma as u,Na as m,Oa as b,P as ge,Q as W,R as ve,Ra as B,S as Y,Sa as F,Va as T,Wa as h,Xa as $,Ya as H,Z as k,_ as J,_a as ke,_c as ie,ab as Te,bb as I,cb as ee,d as ae,da as A,db as te,ea as w,i as se,ib as R,j as q,ja as N,jb as S,ka as X,l as ce,lb as y,mb as ye,oa as L,p as le,qb as P,rb as xe,t as ue,ta as p,tb as V,ua as g,ve as Me,x as pe,xb as Ne,xe as De,yb as G,ye as Ee,z as me}from"./chunk-7SN5N7H7.js";var Q=class{static preprocessTextString(r){let o=[],t=r.split(`
`),e=0;return t.forEach(i=>{i.includes("--choiceEnd")?e--:i.includes("--choice")&&e++}),o=this.collectLines(t,0)[0],o}static collectLines(r,o){let t=[],e=o;for(;e<r.length;e++)if(!r[e].includes("--choice"))t.push({text:this.processLine(r[e]),index:e});else if(r[e].includes("--choiceLink"))t.push({text:r[e].replace("--choiceLink ",""),index:e});else{if(r[e].includes("--choiceEnd"))break;if(r[e].includes("--choice")){let i={text:r[e].replace("--choice ",""),isChoice:!0,innerLines:[],index:e},a=this.collectLines(r,e+1);i.innerLines=a[0],e=a[1],t.push(i)}}return[t,e]}static processLine(r){return r.replaceAll("\\n",`
`)}};var Ye=n=>({active:n});function Je(n,r){if(n&1){let o=F();u(0,"button",3),T("click",function(){A(o);let e=h();return w(e.addBookmark.emit(e.line.index))}),m()}if(n&2){let o=h();d("ngClass",y(2,Ye,o.isBookmark))("tuiHint",o.isBookmark?"Remove bookmark":"Add bookmark")}}var ne=(()=>{let r=class r{constructor(){this.addBookmark=new X,this.hoveredLine=!1}get _classes(){return["chapter-reading_line"]}onHover(t){if(!t){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.hoveredLine=t},0);return}clearTimeout(this.timeout),this.hoveredLine=t}};r.\u0275fac=function(e){return new(e||r)},r.\u0275cmp=k({type:r,selectors:[["reading-line"]],hostVars:2,hostBindings:function(e,i){e&2&&j(i._classes)},inputs:{line:"line",isBookmark:"isBookmark"},outputs:{addBookmark:"addBookmark"},standalone:!0,features:[S],decls:3,vars:2,consts:[[3,"mouseover","mouseout"],["icon","tuiIconBookmarkLarge","tuiIconButton","","appearance","bookmark","tuiHintAppearance","onDark",1,"chapter-reading_bookmark-button",3,"ngClass","tuiHint"],[3,"innerHtml"],["icon","tuiIconBookmarkLarge","tuiIconButton","","appearance","bookmark","tuiHintAppearance","onDark",1,"chapter-reading_bookmark-button",3,"click","ngClass","tuiHint"]],template:function(e,i){e&1&&(u(0,"div",0),T("mouseover",function(){return i.onHover(!0)})("mouseout",function(){return i.onHover(!1)}),_(1,Je,1,4,"button",1),b(2,"pre",2),m()),e&2&&(p(),O(1,i.hoveredLine||i.isBookmark?1:-1),p(),d("innerHtml",i.line.text,L))},dependencies:[V,we,Se,Ae,Ie,Re,Fe,je],encapsulation:2});let n=r;return n})();var re=new ve("MutationObserver config");var oe=(()=>{class n extends ae{constructor({nativeElement:o},t){super(e=>{let i=new MutationObserver(a=>{e.next(a)});return i.observe(o,t),()=>{i.disconnect()}})}}return n.\u0275fac=function(o){return new(o||n)(Y(N),Y(re))},n.\u0275prov=ge({token:n,factory:n.\u0275fac}),n})();var Ze=["*"],Xe=(()=>{class n{constructor(o,t,e){this.el=o,this.resize$=t,this.mutation$=e,this.tuiElasticContainer=ue(this.resize$,this.mutation$).pipe(me(0),ce(()=>this.el.nativeElement.clientHeight-1),de())}}return n.\u0275fac=function(o){return new(o||n)(g(N),g(ie),g(oe))},n.\u0275dir=Z({type:n,selectors:[["","tuiElasticContainer",""]],outputs:{tuiElasticContainer:"tuiElasticContainer"},features:[R([ie,oe,{provide:re,useValue:{childList:!0,characterData:!0,subtree:!0}}])]}),n})(),ze=(()=>{class n{constructor(){this.height=NaN,this.transitions=0}onAnimation(o,t){this.transitions+=t}}return n.\u0275fac=function(o){return new(o||n)},n.\u0275cmp=k({type:n,selectors:[["tui-elastic-container"]],hostVars:4,hostBindings:function(o,t){o&2&&(_e("height",t.height,"px"),Ce("_transitioning",t.transitions))},ngContentSelectors:Ze,decls:2,vars:0,consts:[[1,"t-wrapper",3,"transitioncancel.silent","transitionend.silent","transitionstart.silent","tuiElasticContainer"]],template:function(o,t){o&1&&($(),u(0,"div",0),T("transitioncancel.silent",function(i){return t.onAnimation(i.propertyName,-1)})("transitionend.silent",function(i){return t.onAnimation(i.propertyName,-1)})("transitionstart.silent",function(i){return t.onAnimation(i.propertyName,1)})("tuiElasticContainer",function(i){return t.height=i}),H(1),m())},dependencies:[Xe],styles:["[_nghost-%COMP%]{transition-property:height;transition-duration:var(--tui-duration, .3s);transition-timing-function:ease-in-out;display:block;overflow:hidden}._transitioning[_nghost-%COMP%]{height:auto!important}.t-wrapper[_ngcontent-%COMP%]{padding-top:1px;margin-top:-1px}"],changeDetection:0}),se([Be(r=>r==="height")],n.prototype,"onAnimation",null),n})(),Ue=(()=>{class n{}return n.\u0275fac=function(o){return new(o||n)},n.\u0275mod=J({type:n}),n.\u0275inj=W({}),n})();var et=["*"],tt=n=>({spoiler:n});function it(n,r){n&1&&B(0)}function nt(n,r){if(n&1&&b(0,"pre",3),n&2){let o=h();d("innerHtml",o.comment,L)}}function rt(n,r){n&1&&B(0)}function ot(n,r){if(n&1&&(u(0,"a",6),ee(1),m()),n&2){let o=r.$implicit;d("routerLink",o.link),p(),te(o.text)}}function at(n,r){if(n&1&&(u(0,"a",8),ee(1),m()),n&2){let o=r.$implicit;d("routerLink",o.link)("ngClass",y(3,tt,o.spoiler)),p(),te(o.text)}}function st(n,r){if(n&1&&(u(0,"div",5),D(1,ot,2,2,"a",6,M),m(),u(3,"div",7),D(4,at,2,5,"a",8,M),m()),n&2){let o=h();p(),E(o.prev),p(3),E(o.next)}}var Qe=(()=>{let r=class r{constructor(){this.comment="",this.prev=[],this.next=[]}get _classes(){return["navigation"]}set navigationData(t){t&&this.onNavigationDataChange(t)}onNavigationDataChange(t){if(this.prev=[],this.next=[],!t)return;let e=t?.chapter,i=t?.chapterData,a=t.route,s=t.routeData;if(e&&i){let c=i.chapters[e],l=this.nextChapterKey(e,i),v=this.prevChapterKey(e,i),f=s?.items.find(x=>x.routerLink==a)?.name||"";f&&(f+=" ");let C=0;i.chapterOrder?C=i.chapterOrder.findIndex(x=>x==e)+1:C=Number(e),!c?.next&&C<i.total&&this.initSimpleNav(this.next,f,i,l),!c?.prev&&C>1&&this.initSimpleNav(this.prev,f,i,v),this.initArrayNaV(this.next,c?.next,a,f,i,s),this.initArrayNaV(this.prev,c?.prev,a,f,i,s),this.comment=c?.comment||""}}initSimpleNav(t,e,i,a){let s="";if(i.total==Object.keys(i.chapters).length||i.chapters[a]){let c=i.chapters[a].name||"",l="",v=a;v>="0"&&v<="9"&&(l=`Chapter ${a}`),l&&c&&(c=": "+c),s=`${l}${c}`}else s=`Chapter ${a}`;t.push({link:`../${a}`,text:`${e} ${s}`})}initArrayNaV(t,e,i,a,s,c){e?.forEach(l=>{let v=l.index,f="",C="";/^\d+[A-Za-z0-9\-_]*$/gm.test(v)&&(C=`Chapter ${v}`),i!=l.route&&l.name?f=l.name:(s.total==Object.keys(s.chapters).length||s.chapters[v])&&(f=s.chapters[v]?.name||""),C&&f&&(f=": "+f);let x=`${C}${f}`;if(i!=l.route){let Ke=c.items.find(qe=>qe.routerLink==l.route)?.name;t.push({link:`../../${l.route}/${v||"1"}`,text:`${Ke} ${x}`.trim(),spoiler:!!l.spoiler})}else t.push({link:`../${v}`,text:`${a} ${x}`.trim(),spoiler:!!l.spoiler})})}nextChapterKey(t,e){if(e.chapterOrder){let i=e.chapterOrder.findIndex(a=>a==t);return e.chapterOrder[i+1]}else return(Number(t)+1).toString()}prevChapterKey(t,e){if(e.chapterOrder){let i=e.chapterOrder.findIndex(a=>a==t);return e.chapterOrder[i-1]}else return(Number(t)-1).toString()}};r.\u0275fac=function(e){return new(e||r)},r.\u0275cmp=k({type:r,selectors:[["navigation"]],hostVars:2,hostBindings:function(e,i){e&2&&j(i._classes)},inputs:{navigationData:"navigationData"},standalone:!0,features:[S],ngContentSelectors:et,decls:8,vars:3,consts:[["navigationElemsTemplate",""],[1,"navigation_container"],[4,"ngTemplateOutlet"],[1,"navigation_comment",3,"innerHtml"],[1,"navigation_container","bottom"],[1,"navigation_prev"],["icon","tuiIconChevronsLeft","iconAlign","left","tuiLink","",3,"routerLink"],[1,"navigation_next"],["icon","tuiIconChevronsRight","tuiLink","",3,"routerLink","ngClass"]],template:function(e,i){if(e&1&&($(),u(0,"div",1),_(1,it,1,0,"ng-container",2),m(),H(2),_(3,nt,1,1,"pre",3),u(4,"div",4),_(5,rt,1,0,"ng-container",2),m(),_(6,st,6,0,"ng-template",null,0,P)),e&2){let a=I(7);p(),d("ngTemplateOutlet",a),p(2),O(3,i.comment?3:-1),p(2),d("ngTemplateOutlet",a)}},dependencies:[V,G,He,$e,Ee],encapsulation:2});let n=r;return n})();var ct=n=>({line:n,depth:0}),lt=n=>({"--choiceDepth":n}),ut=(n,r)=>({line:n,depth:r});function pt(n,r){if(n&1&&B(0,8),n&2){let o=r.$implicit;h();let t=I(12);d("ngTemplateOutlet",t)("ngTemplateOutletContext",y(2,ct,o))}}function mt(n,r){if(n&1&&B(0,8),n&2){let o=r.$implicit,t=h(2).depth;h();let e=I(12);d("ngTemplateOutlet",e)("ngTemplateOutletContext",ye(2,ut,o,t+1))}}function dt(n,r){if(n&1&&(u(0,"details",10),b(1,"summary",11),u(2,"div",12),D(3,mt,1,5,"ng-container",8,M),m()()),n&2){let o=h(),t=o.line,e=o.depth;p(),d("innerHtml",t.text,L),p(),d("ngStyle",y(2,lt,e+1)),p(),E(t.innerLines)}}function ht(n,r){if(n&1){let o=F();u(0,"reading-line",13),T("addBookmark",function(e){A(o);let i=h(2);return w(i.addBookmark(e))}),m()}if(n&2){let o=h().line,t=h();d("line",o)("isBookmark",o.index==t.currentBookmark)}}function ft(n,r){if(n&1&&_(0,dt,5,4,"details",10)(1,ht,1,2),n&2){let o=r.line;O(0,o.isChoice?0:1)}}var _i=(()=>{let r=class r{constructor(t,e,i,a,s,c){this.activeRoute=t,this.restApiService=e,this.router=i,this.gameRootService=a,this.globalLoader=s,this.cdr=c,this._loading=!0,this.currentBookmark=-1,this.routed=!1,this.toBookmark=!1}ngOnInit(){let t={};this.activeRoute.parent?.paramMap.pipe(pe([this.activeRoute.paramMap,this.activeRoute.parent.queryParamMap]),fe(()=>{this.globalLoader.setGlobalLoader(!0),this.cdr.detectChanges()}),he(e=>{this.currentBookmark=-1,this.toBookmark=!1,t={};let i=e[0].get("gameName")!=this.gameName;this.gameName=e[0].get("gameName"),this.chapter=e[1].get("chapterNumber")||"",t.chapter=this.chapter;let a=this.routePath!=(e[1].get("routeName")||"");this.routePath=e[1].get("routeName")||"",t.route=this.routePath,this.routed=e[1].has("routeName"),this.parseQueryParams(e[2]);let s=this.routed?"routedGameChapterConfig":"nonRoutedGameChapterConfig",c=this.routed?"routedChapterFile":"nonRoutedChapterFile",l={config:a?this.restApiService.get(s,{pathParams:{gameName:this.gameName,routeName:e[1].get("routeName")}}):q(this.chapterData),chapter:this.restApiService.get(c,{pathParams:{gameName:this.gameName,routeName:e[1].get("routeName"),file:`${this.chapter}.txt`},requestOptions:{headers:new Le({Accept:"application/json;charset=utf-8"}),responseType:"text"}})};return this.routed&&(l.routeConfig=i?this.restApiService.get("gameRouteConfig",{pathParams:{gameName:this.gameName}}):q(this.routeData)),le(l)})).subscribe({next:e=>{this.chapterData=e.config,e.routeConfig&&(this.routeData=e.routeConfig,t.routeData=this.routeData),t.chapterData=this.chapterData,this.lines=Q.preprocessTextString(e.chapter),this.navigationData=t,this.name=this.resolveName(this.chapterData.chapters,e),this.gameRootService.pushHeader(this.name),setTimeout(()=>{Array.prototype.slice.call(document.getElementsByClassName("dict")).forEach(i=>{i.addEventListener("click",this.openTip.bind(this))})},100)},error:()=>{this.router.navigate(["/error"]),this.globalLoader.setGlobalLoader(!1)}})}ngAfterViewInit(){this.chapterLinesRef.changes.subscribe(()=>{this.toBookmark?this.findBookMarkAndScroll():(window.scroll(0,0),this.globalLoader.setGlobalLoader(!1))})}addBookmark(t){let e=z.bookmarkTemplateKey.replace("{gameName}",this.gameName);if(this.currentBookmark==t)localStorage.removeItem(e),this.currentBookmark=-1;else{this.currentBookmark=t;let i=z.bookmarkTemplateValue[`${this.routed}`];i=i.replace("{routeName}",this.routePath).replace("{chapterIndex}",this.chapter).replace("{lineIndex}",`${this.currentBookmark}`),localStorage.setItem(e,i)}this.gameRootService.emitBookmarkChange()}parseQueryParams(t){let e=t.get("toBookmark"),i=z.bookmarkTemplateKey.replace("{gameName}",this.gameName),a=localStorage.getItem(i)?.split(":")||[],s=this.routed?a[0]===this.routePath&&a[1]===this.chapter:a[0]===this.chapter;this.toBookmark=s&&e==="true",s&&(this.currentBookmark=Number(a[a.length-1]))}findBookMarkAndScroll(){if(this.findLine(this.lines,this.currentBookmark)){let e=this.chapterLinesRef.find(a=>a.nativeElement.childNodes[0].childNodes[0].nodeName==="BUTTON")?.nativeElement,i=e;for(;!i.className.includes("chapter-reading_content-text");)i=i.parentElement,i.className.includes("chapter-reading_choice")&&i.tagName=="DETAILS"&&(i.open=!0);setTimeout(()=>{this.scrollWithOffset(e,-15),this.globalLoader.setGlobalLoader(!1)},600)}}scrollWithOffset(t,e){let i=t.getBoundingClientRect().top+window.scrollY+e;window.scrollTo({top:i})}findLine(t,e){if(t[e]&&t[e].index==e)return t[e];for(let i=0;i<t.length;i++){if(t[i].index==e)return t[i];if(t[i].isChoice){if(i+1<t.length){if(e<(t[i+1].index||Number.POSITIVE_INFINITY)){let s=this.findLine(t[i].innerLines,e);if(s!=null)return s}continue}let a=this.findLine(t[i].innerLines,e);if(a!=null)return a}}return null}openTip(t){let e=this.router.createUrlTree([`/games/${this.gameName}/tips`],{queryParams:{filter:this.resolveKanji(t.currentTarget.innerHTML)}}),i=window.location.href.replace(this.router.url,"");window.open(i+e,"_blank")}resolveName(t,e){let i=t[this.chapter],a="";e.routeConfig&&(a=e.routeConfig.items.find(c=>c.routerLink===this.routePath)?.name+" - ");let s="";return i&&i?.name?(s=`${a}`,this.chapter[0]>="0"&&this.chapter[0]<="9"&&(s+=`${this.chapter}: `),s+=`${i?.name}`):s=`${a}Chapter ${this.chapter}`,s}resolveKanji(t){let e=t.replaceAll("<ruby>","").replaceAll("</ruby>","");if(e.includes("\u2022"))return e.replaceAll("<rt>\u2022</rt>","");if(e.includes("<rt>")){let i=/<rt>(.*?)<\/rt>/gm;[...e.matchAll(i)].forEach(s=>{e=e.replaceAll(s[0],"")})}return e}};r.\u0275fac=function(e){return new(e||r)(g(Me),g(U),g(De),g(Ge),g(Oe),g(xe))},r.\u0275cmp=k({type:r,selectors:[["reading-component"]],viewQuery:function(e,i){if(e&1&&ke(ne,5,N),e&2){let a;be(a=Te())&&(i.chapterLinesRef=a)}},standalone:!0,features:[R([U]),S],decls:13,vars:1,consts:[["readableLines",""],[1,"chapter-reading"],[1,"chapter-reading_body"],[1,"chapter-reading_content"],[1,"chapter-reading_content-island"],[3,"navigationData"],[1,"chapter-reading_spacer"],[1,"chapter-reading_content-text"],[3,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"chapter-reading_spacer","bottom"],[1,"chapter-reading_choice"],[3,"innerHtml"],[1,"chapter-reading_choice-content",3,"ngStyle"],[1,"chapter-reading_line-node",3,"addBookmark","line","isBookmark"]],template:function(e,i){e&1&&(u(0,"div",1)(1,"div",2)(2,"div",3)(3,"tui-island",4)(4,"tui-elastic-container")(5,"navigation",5),b(6,"hr",6),u(7,"div",7),D(8,pt,1,4,"ng-container",8,M),m(),b(10,"hr",9),m()()()()()(),_(11,ft,2,1,"ng-template",null,0,P)),e&2&&(p(5),d("navigationData",i.navigationData),p(3),E(i.lines))},dependencies:[Ne,G,ne,Qe,Ue,ze,Ve,Pe],encapsulation:2});let n=r;return n})();export{_i as ReadingComponent};
