import{a as Re}from"./chunk-3SD6P5XB.js";import{a as $}from"./chunk-KGA3LBVL.js";import{a as Qe}from"./chunk-U4XC2GOP.js";import{a as Ee}from"./chunk-SW5ADHBM.js";import{a as He,b as Pe}from"./chunk-UFRAF5IV.js";import{f as Be,g as we,i as Fe,k as je,l as $e}from"./chunk-XLIKHLUI.js";import"./chunk-JJAHF3FC.js";import{a as Ve,b as ze}from"./chunk-XYLHXVLH.js";import{a as Ge,b as Ue}from"./chunk-3VTLMZWP.js";import{c as j}from"./chunk-QPXJIEBY.js";import{$ as k,$a as B,Ab as Y,B as ce,E as le,Ea as _,Ga as c,Ha as fe,Ia as ge,Ja as ve,Ka as m,Kb as Ie,L as ue,La as d,Ma as C,Mb as Se,Na as _e,Nb as Ae,O as pe,Oa as Ce,Pa as K,Qa as R,R as me,S as z,T as de,Ta as T,U as G,Ua as g,Va as ke,Wa as be,Ya as Te,Za as ye,_ as he,_a as xe,aa as U,ab as D,ba as Q,bb as W,cb as Ne,cd as Z,f as ie,fa as S,g as ne,ga as A,gb as E,hb as L,jb as y,k as re,kb as Oe,l as V,la as N,ma as q,n as I,ob as J,pb as Le,qa as O,r as oe,rb as w,tb as F,ub as M,v as ae,va as p,vb as Me,wa as v,wb as De,z as se}from"./chunk-KN6KQJWB.js";var H=class{static preprocessTextString(r){let o=[],i=r.split(`
`),e=0;return i.forEach(t=>{t.includes("--choiceEnd")?e--:t.includes("--choice")&&e++,e<0&&console.error("wrong folding")}),o=this.collectLines(i,0)[0],o}static collectLines(r,o){let i=[],e=o;for(;e<r.length;e++)if(!r[e].includes("--choice"))i.push({text:this.processLine(r[e]),index:e});else if(r[e].includes("--choiceLink"))i.push({text:r[e].replace("--choiceLink ",""),index:e});else{if(r[e].includes("--choiceEnd"))break;if(r[e].includes("--choice")){let t={text:r[e].replace("--choice ",""),isChoice:!0,innerLines:[],index:e},a=this.collectLines(r,e+1);t.innerLines=a[0],e=a[1],i.push(t)}}return[i,e]}static processLine(r){return r.replaceAll("\\n",`
`)}};var Xe=n=>({active:n});function et(n,r){if(n&1){let o=R();m(0,"button",3),T("click",function(){S(o);let e=g();return A(e.addBookmark.emit(e.line.index))}),d()}if(n&2){let o=g();c("ngClass",y(2,Xe,o.isBookmark))("tuiHint",o.isBookmark?"Remove bookmark":"Add bookmark")}}var X=(()=>{let r=class r{constructor(){this.addBookmark=new q,this.hoveredLine=!1}onHover(i){if(!i){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.hoveredLine=i},0);return}clearTimeout(this.timeout),this.hoveredLine=i}};r.\u0275fac=function(e){return new(e||r)},r.\u0275cmp=k({type:r,selectors:[["reading-line"]],inputs:{line:"line",isBookmark:"isBookmark"},outputs:{addBookmark:"addBookmark"},standalone:!0,features:[L],decls:3,vars:2,consts:[[1,"chapter-reading_line",3,"mouseover","mouseout"],["class","chapter-reading_bookmark-button","icon","tuiIconBookmarkLarge","tuiIconButton","","appearance","bookmark","tuiHintAppearance","onDark",3,"ngClass","tuiHint","click",4,"ngIf"],[3,"innerHtml"],["icon","tuiIconBookmarkLarge","tuiIconButton","","appearance","bookmark","tuiHintAppearance","onDark",1,"chapter-reading_bookmark-button",3,"click","ngClass","tuiHint"]],template:function(e,t){e&1&&(m(0,"div",0),T("mouseover",function(){return t.onHover(!0)})("mouseout",function(){return t.onHover(!1)}),_(1,et,1,4,"button",1),C(2,"pre",2),d()),e&2&&(p(),c("ngIf",t.hoveredLine||t.isBookmark),p(),c("innerHtml",t.line.text,O))},dependencies:[M,w,$e,Be,je,we,Fe,Pe,He],encapsulation:2});let n=r;return n})();var ee=new de("MutationObserver config");var te=(()=>{class n extends ie{constructor({nativeElement:o},i){super(e=>{let t=new MutationObserver(a=>{e.next(a)});return t.observe(o,i),()=>{t.disconnect()}})}}return n.\u0275fac=function(o){return new(o||n)(G(N),G(ee))},n.\u0275prov=me({token:n,factory:n.\u0275fac}),n})();var tt=["*"],it=(()=>{class n{constructor(o,i,e){this.el=o,this.resize$=i,this.mutation$=e,this.tuiElasticContainer=ae(this.resize$,this.mutation$).pipe(ce(0),I(()=>this.el.nativeElement.clientHeight-1),le())}}return n.\u0275fac=function(o){return new(o||n)(v(N),v(Z),v(te))},n.\u0275dir=Q({type:n,selectors:[["","tuiElasticContainer",""]],outputs:{tuiElasticContainer:"tuiElasticContainer"},features:[E([Z,te,{provide:ee,useValue:{childList:!0,characterData:!0,subtree:!0}}])]}),n})(),qe=(()=>{class n{constructor(){this.height=NaN,this.transitions=0}onAnimation(o,i){this.transitions+=i}}return n.\u0275fac=function(o){return new(o||n)},n.\u0275cmp=k({type:n,selectors:[["tui-elastic-container"]],hostVars:4,hostBindings:function(o,i){o&2&&(fe("height",i.height,"px"),ge("_transitioning",i.transitions))},ngContentSelectors:tt,decls:2,vars:0,consts:[[1,"t-wrapper",3,"transitioncancel.silent","transitionend.silent","transitionstart.silent","tuiElasticContainer"]],template:function(o,i){o&1&&(ke(),m(0,"div",0),T("transitioncancel.silent",function(t){return i.onAnimation(t.propertyName,-1)})("transitionend.silent",function(t){return i.onAnimation(t.propertyName,-1)})("transitionstart.silent",function(t){return i.onAnimation(t.propertyName,1)})("tuiElasticContainer",function(t){return i.height=t}),be(1),d())},dependencies:[it],styles:["[_nghost-%COMP%]{transition-property:height;transition-duration:var(--tui-duration, .3s);transition-timing-function:ease-in-out;display:block;overflow:hidden}._transitioning[_nghost-%COMP%]{height:auto!important}.t-wrapper[_ngcontent-%COMP%]{padding-top:1px;margin-top:-1px}"],changeDetection:0}),re([Re(r=>r==="height")],n.prototype,"onAnimation",null),n})(),Ke=(()=>{class n{}return n.\u0275fac=function(o){return new(o||n)},n.\u0275mod=U({type:n}),n.\u0275inj=z({}),n})();var nt=n=>({spoiler:n});function rt(n,r){if(n&1&&C(0,"pre",6),n&2){let o=g();c("innerHtml",o.comment,O)}}function ot(n,r){if(n&1&&(m(0,"a",7),D(1),d()),n&2){let o=r.$implicit;c("routerLink",o.link),p(),W(o.text)}}function at(n,r){if(n&1&&(m(0,"a",8),D(1),d()),n&2){let o=r.$implicit;c("routerLink",o.link)("ngClass",y(3,nt,o.spoiler)),p(),W(o.text)}}var We=(()=>{let r=class r{get _classes(){return["navigation"]}set navigationData(i){this.changeNavigationData.next(i)}constructor(){this.bottomTextLMAO=!1,this.changeNavigationData=new ne,this.comment="",this.prev=[],this.next=[],this.changeNavigationData.subscribe(i=>{if(this.prev=[],this.next=[],!i)return;let e=i?.chapter,t=i?.chapterData,a=i.route,s=i.routeData;if(e&&t){let l=t.chapters[e],u=this.nextChapterKey(e,t),h=this.prevChapterKey(e,t),f=s?.items.find(x=>x.routerLink==a)?.name||"";f&&(f+=" ");let b=0;t.chapterOrder?b=t.chapterOrder.findIndex(x=>x==e)+1:b=Number(e),!l?.next&&b<t.total&&this.initSimpleNav(this.next,f,t,u),!l?.prev&&b>1&&this.initSimpleNav(this.prev,f,t,h),this.initArrayNaV(this.next,l?.next,a,f,t,s),this.initArrayNaV(this.prev,l?.prev,a,f,t,s),this.bottomTextLMAO&&(this.comment=l?.comment||"")}})}initSimpleNav(i,e,t,a){let s="";if(t.total==Object.keys(t.chapters).length||t.chapters[a]){let l=t.chapters[a].name||"",u="",h=a;h>="0"&&h<="9"&&(u=`Chapter ${a}`),l!=""&&(l=": "+l),s=`${u}${l}`}else s=`Chapter ${a}`;i.push({link:`../${a}`,text:`${e} ${s}`})}initArrayNaV(i,e,t,a,s,l){e?.forEach(u=>{let h=u.index,f="",b="";/^\d+[A-Za-z0-9\-_]*$/gm.test(h)&&(b=`Chapter ${h}`),t!=u.route&&u.name?f=u.name:(s.total==Object.keys(s.chapters).length||s.chapters[h])&&(f=s.chapters[h]?.name||""),f!=""&&(f=": "+f);let x=`${b}${f}`;if(t!=u.route){let Je=l.items.find(Ye=>Ye.routerLink==u.route)?.name;i.push({link:`../../${u.route}/${h||"1"}`,text:`${Je} ${x}`.trim(),spoiler:!!u.spoiler})}else i.push({link:`../${h}`,text:`${a} ${x}`.trim(),spoiler:!!u.spoiler})})}nextChapterKey(i,e){if(e.chapterOrder){let t=e.chapterOrder.findIndex(a=>a==i);return e.chapterOrder[t+1]}else return(Number(i)+1).toString()}prevChapterKey(i,e){if(e.chapterOrder){let t=e.chapterOrder.findIndex(a=>a==i);return e.chapterOrder[t-1]}else return(Number(i)-1).toString()}};r.\u0275fac=function(e){return new(e||r)},r.\u0275cmp=k({type:r,selectors:[["navigation"]],hostVars:2,hostBindings:function(e,t){e&2&&ve(t._classes)},inputs:{navigationData:"navigationData",bottomTextLMAO:[he.None,"bottom","bottomTextLMAO"]},standalone:!0,features:[L],decls:6,vars:3,consts:[["class","navigation_comment",3,"innerHtml",4,"ngIf"],[1,"navigation_container"],[1,"navigation_prev"],["icon","tuiIconChevronsLeft","iconAlign","left","tuiLink","",3,"routerLink",4,"ngFor","ngForOf"],[1,"navigation_next"],["icon","tuiIconChevronsRight","tuiLink","",3,"routerLink","ngClass",4,"ngFor","ngForOf"],[1,"navigation_comment",3,"innerHtml"],["icon","tuiIconChevronsLeft","iconAlign","left","tuiLink","",3,"routerLink"],["icon","tuiIconChevronsRight","tuiLink","",3,"routerLink","ngClass"]],template:function(e,t){e&1&&(_(0,rt,1,1,"pre",0),m(1,"div",1)(2,"div",2),_(3,ot,2,2,"a",3),d(),m(4,"div",4),_(5,at,2,5,"a",5),d()()),e&2&&(c("ngIf",t.bottomTextLMAO&&t.comment),p(3),c("ngForOf",t.prev),p(2),c("ngForOf",t.next))},dependencies:[M,F,w,ze,Ve,Ae],encapsulation:2});let n=r;return n})();var st=n=>({line:n,depth:0}),ct=n=>({"--choiceDepth":n}),lt=(n,r)=>({line:n,depth:r});function ut(n,r){if(n&1&&(m(0,"div"),D(1),d()),n&2){let o=r.$implicit;p(),Ne(" ",o," ")}}function pt(n,r){if(n&1&&K(0,13),n&2){let o=r.$implicit;g();let i=B(13);c("ngTemplateOutlet",i)("ngTemplateOutletContext",y(2,st,o))}}function mt(n,r){if(n&1&&K(0,13),n&2){let o=r.$implicit,i=g(2).depth;g();let e=B(13);c("ngTemplateOutlet",e)("ngTemplateOutletContext",Oe(2,lt,o,i+1))}}function dt(n,r){if(n&1&&(_e(0),m(1,"details",15),C(2,"summary",16),m(3,"div",17),_(4,mt,1,5,"ng-container",10),d()(),Ce()),n&2){let o=g(),i=o.line,e=o.depth;p(2),c("innerHtml",i.text,O),p(),c("ngStyle",y(3,ct,e+1)),p(),c("ngForOf",i.innerLines)}}function ht(n,r){if(n&1){let o=R();m(0,"reading-line",18),T("addBookmark",function(e){S(o);let t=g(2);return A(t.addBookmark(e))}),d()}if(n&2){let o=g().line,i=g();c("line",o)("isBookmark",o.index==i.currentBookmark)}}function ft(n,r){if(n&1&&_(0,dt,5,5,"ng-container",14)(1,ht,1,2,"ng-template",null,1,J),n&2){let o=r.line,i=B(2);c("ngIf",o.isChoice)("ngIfElse",i)}}var _i=(()=>{let r=class r{constructor(i,e,t,a,s,l){this.activeRoute=i,this.restApiService=e,this.router=t,this.gameRootService=a,this.globalLoader=s,this.cdr=l,this._loading=!0,this.currentBookmark=-1,this.routed=!1,this.toBookmark=!1}ngOnInit(){let i={};this.activeRoute.parent?.paramMap.pipe(se([this.activeRoute.paramMap,this.activeRoute.parent.queryParamMap]),pe(()=>{this.globalLoader.setGlobalLoader(!0),this.cdr.detectChanges()}),ue(e=>{this.currentBookmark=-1,this.toBookmark=!1,i={};let t=e[0].get("gameName")!=this.gameName;this.gameName=e[0].get("gameName"),this.chapter=e[1].get("chapterNumber")||"",i.chapter=this.chapter;let a=this.routePath!=(e[1].get("routeName")||"");this.routePath=e[1].get("routeName")||"",i.route=this.routePath,this.routed=e[1].has("routeName"),this.parseQueryParams(e[2]);let s=this.routed?"routedGameChapterConfig":"nonRoutedGameChapterConfig",l=this.routed?"routedChapterFile":"nonRoutedChapterFile",u={config:a?this.restApiService.get(s,{pathParams:{gameName:this.gameName,routeName:e[1].get("routeName")},requestOptions:{headers:new Y({Accept:"application/json;charset=utf-8","Content-Encoding":"gzip"})}}).pipe(I(h=>JSON.parse(h))):V(this.chapterData),chapter:this.restApiService.get(l,{pathParams:{gameName:this.gameName,routeName:e[1].get("routeName"),file:`${this.chapter}.txt.gz`},requestOptions:{headers:new Y({Accept:"application/json;charset=utf-8","Content-Encoding":"gzip"}),responseType:"text"}})};return this.routed&&(u.routeConfig=t?this.restApiService.get("gameRouteConfig",{pathParams:{gameName:this.gameName}}):V(this.routeData)),oe(u)})).subscribe({next:e=>{this.chapterData=e.config,e.routeConfig&&(this.routeData=e.routeConfig,i.routeData=this.routeData),i.chapterData=this.chapterData,this.lines=H.preprocessTextString(e.chapter),this.navigationData=i,this.name=this.resolveName(this.chapterData.chapters,e),this.gameRootService.pushHeader(this.name),setTimeout(()=>{Array.prototype.slice.call(document.getElementsByClassName("chapter-reading_dict")).forEach(t=>{t.addEventListener("click",this.openTip.bind(this))})},100)},error:()=>{this.router.navigate(["/error"]),this.globalLoader.setGlobalLoader(!1)}})}ngAfterViewInit(){this.chapterLinesRef.changes.subscribe(()=>{this.toBookmark?this.findBookMarkAndScroll():(window.scroll(0,0),this.globalLoader.setGlobalLoader(!1))})}addBookmark(i){let e=j.bookmarkTemplateKey.replace("{gameName}",this.gameName);if(this.currentBookmark==i)localStorage.removeItem(e),this.currentBookmark=-1;else{this.currentBookmark=i;let t=j.bookmarkTemplateValue[`${this.routed}`];t=t.replace("{routeName}",this.routePath).replace("{chapterIndex}",this.chapter).replace("{lineIndex}",`${this.currentBookmark}`),localStorage.setItem(e,t)}this.gameRootService.emitBookmarkChange()}parseQueryParams(i){let e=i.get("toBookmark"),t=j.bookmarkTemplateKey.replace("{gameName}",this.gameName),a=localStorage.getItem(t)?.split(":")||[],s=this.routed?a[0]===this.routePath&&a[1]===this.chapter:a[0]===this.chapter;this.toBookmark=s&&e==="true",s&&(this.currentBookmark=Number(a[a.length-1]))}findBookMarkAndScroll(){if(this.findLine(this.lines,this.currentBookmark)){let e=this.chapterLinesRef.find(a=>a.nativeElement.childNodes[0].childNodes[0].nodeName==="BUTTON")?.nativeElement,t=e;for(;!t.className.includes("chapter-reading_content-text");)t=t.parentElement,t.className.includes("chapter-reading_choice")&&t.tagName=="DETAILS"&&(t.open=!0);setTimeout(()=>{this.scrollWithOffset(e,-15),this.globalLoader.setGlobalLoader(!1)},600)}}scrollWithOffset(i,e){let t=i.getBoundingClientRect().top+window.scrollY+e;window.scrollTo({top:t})}findLine(i,e){if(i[e]&&i[e].index==e)return i[e];for(let t=0;t<i.length;t++){if(i[t].index==e)return i[t];if(i[t].isChoice){if(t+1<i.length){if(e<(i[t+1].index||Number.POSITIVE_INFINITY)){let s=this.findLine(i[t].innerLines,e);if(s!=null)return s}continue}let a=this.findLine(i[t].innerLines,e);if(a!=null)return a}}return null}openTip(i){let e=this.router.createUrlTree([`/games/${this.gameName}/tips`],{queryParams:{filter:this.resolveKanji(i.currentTarget.innerHTML)}}),t=window.location.href.replace(this.router.url,"");window.open(t+e,"_blank")}resolveName(i,e){let t=i[this.chapter],a="";e.routeConfig&&(a=e.routeConfig.items.find(l=>l.routerLink===this.routePath)?.name+" - ");let s="";return t&&t?.name?(s=`${a}`,this.chapter[0]>="0"&&this.chapter[0]<="9"&&(s+=`${this.chapter}: `),s+=`${t?.name}`):s=`${a}Chapter ${this.chapter}`,s}resolveKanji(i){let e=i.replaceAll("<ruby>","").replaceAll("</ruby>","");if(e.includes("\u2022"))return e.replaceAll("<rt>\u2022</rt>","");if(e.includes("<rt>")){let t=/<rt>[ぁ-んァ-ン]+<\/rt>/gm;[...e.matchAll(t)].forEach(s=>{e=e.replaceAll(s[0],"")})}return e}};r.\u0275fac=function(e){return new(e||r)(v(Ie),v($),v(Se),v(Qe),v(Ee),v(Le))},r.\u0275cmp=k({type:r,selectors:[["reading-component"]],viewQuery:function(e,t){if(e&1&&Te(X,5,N),e&2){let a;ye(a=xe())&&(t.chapterLinesRef=a)}},standalone:!0,features:[E([$]),L],decls:14,vars:6,consts:[["readableLines",""],["simpleLine",""],[1,"chapter-reading"],[1,"chapter-reading_body"],[1,"chapter-reading_content"],[1,"chapter-reading_content-island"],[3,"bottom","navigationData"],[4,"ngFor","ngForOf"],[1,"chapter-reading_spacer"],[1,"chapter-reading_content-text"],[3,"ngTemplateOutlet","ngTemplateOutletContext",4,"ngFor","ngForOf"],[1,"chapter-reading_spacer","bottom"],[1,"bottom",3,"bottom","navigationData"],[3,"ngTemplateOutlet","ngTemplateOutletContext"],[4,"ngIf","ngIfElse"],[1,"chapter-reading_choice"],[3,"innerHtml"],[1,"chapter-reading_choice-content",3,"ngStyle"],[3,"addBookmark","line","isBookmark"]],template:function(e,t){e&1&&(m(0,"div",2)(1,"div",3)(2,"div",4)(3,"tui-island",5)(4,"tui-elastic-container"),C(5,"navigation",6),_(6,ut,2,1,"div",7),C(7,"hr",8),m(8,"div",9),_(9,pt,1,4,"ng-container",10),d(),C(10,"hr",11)(11,"navigation",12),d()()()()(),_(12,ft,3,2,"ng-template",null,0,J)),e&2&&(p(5),c("bottom",!1)("navigationData",t.navigationData),p(),c("ngForOf",t.navigations),p(3),c("ngForOf",t.lines),p(2),c("bottom",!0)("navigationData",t.navigationData))},dependencies:[F,M,Me,De,X,We,Ke,qe,Ue,Ge],encapsulation:2});let n=r;return n})();export{_i as ReadingComponent};
